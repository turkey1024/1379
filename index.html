<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1379下载站</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo"></div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="搜索..." onkeyup="searchBooks()">
            <button onclick="searchBooks()">搜索</button>
        </div>
    </header>
    
    <div class="container">
        <h2>1379下载站 (<span id="bookCount">0</span>)</h2>
        
        <div class="book-list" id="bookList">
            <div class="loading">正在加载...</div>
        </div>
    </div>
    
    <footer>
        <a href="https://github.com/turkey1024/turkey1024.github.io" style="color: green;">Github项目</a>
    </footer>

    <script>
        async function scanTxtFiles() {
            try {
                const response = await fetch('txt/');
                if (!response.ok) throw new Error('无法访问txt目录');
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                return Array.from(doc.querySelectorAll('a[href$=".txt"]'))
                    .map(a => a.getAttribute('href'))
                    .filter(href => !href.startsWith('?'))
                    .map(href => {
                        const encodedFilename = href.split('/').pop();
                        const decodedFilename = decodeURIComponent(encodedFilename);
                        return {
                            title: decodedFilename.replace('.txt', ''),
                            filename: decodedFilename,
                            path: 'txt/' + encodedFilename // 保持路径编码
                        };
                    });
            } catch (error) {
                console.error('自动扫描失败:', error);
                return [];
            }
        }

        function displayBooks(books) {
            const bookList = document.getElementById('bookList');
            const bookCount = document.getElementById('bookCount');
            
            bookCount.textContent = books.length;
            bookList.innerHTML = books.length ? '' : '<div class="no-results">没有找到电子书</div>';
            
            books.forEach(book => {
                const bookCard = document.createElement('div');
                bookCard.className = 'book-card';
                bookCard.innerHTML = `
                    <div class="book-title">${book.title}</div>
                    <a href="${book.path}" class="download-btn" download="${book.filename}">下载电子书</a>
                `;
                bookList.appendChild(bookCard);
            });
        }

        function searchBooks() {
            if (!window.bookData) return;
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = window.bookData.filter(b => b.title.toLowerCase().includes(term));
            document.getElementById('bookCount').textContent = filtered.length;
            displayBooks(filtered);
        }

        window.onload = async () => {
            window.bookData = await scanTxtFiles();
            displayBooks(window.bookData);
        };
    </script>


</body>
</html>

